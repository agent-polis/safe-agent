name: "Safe Agent Review"
description: "Run safe-agent in CI mode and emit summary/report artifacts."
inputs:
  task:
    description: "Task for safe-agent to run."
    required: false
    default: "scan repository for risky configuration and secret-handling changes; do not edit files"
  python-version:
    description: "Python version used to run safe-agent."
    required: false
    default: "3.11"
  fail-on-risk:
    description: "Optional fail threshold for risk level (low|medium|high|critical)."
    required: false
    default: ""
  dry-run:
    description: "Run safe-agent in dry-run mode."
    required: false
    default: "true"
  policy-file:
    description: "Optional path to policy JSON/YAML file."
    required: false
    default: ""
  policy-preset:
    description: "Optional policy preset (startup|fintech|games)."
    required: false
    default: ""
  working-directory:
    description: "Working directory to evaluate."
    required: false
    default: "."
  artifact-dir:
    description: "Directory where summary/report/log files are written."
    required: false
    default: ".safe-agent-ci"
  anthropic-api-key:
    description: "Anthropic API key."
    required: true
outputs:
  summary_path:
    description: "Markdown CI summary output path."
    value: ${{ steps.run.outputs.summary_path }}
  safety_scorecard_path:
    description: "Markdown safety scorecard output path."
    value: ${{ steps.run.outputs.safety_scorecard_path }}
  policy_report_path:
    description: "Machine-readable policy report path."
    value: ${{ steps.run.outputs.policy_report_path }}
  log_path:
    description: "safe-agent run log path."
    value: ${{ steps.run.outputs.log_path }}
  exit_code:
    description: "safe-agent process exit code."
    value: ${{ steps.run.outputs.exit_code }}
runs:
  using: "composite"
  steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}

    - name: Install safe-agent from repo source
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        python -m pip install --upgrade pip
        pip install .

    - id: run
      name: Run safe-agent risk gate
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        ANTHROPIC_API_KEY: ${{ inputs.anthropic-api-key }}
      run: |
        set +e
        set -o pipefail
        mkdir -p "${{ inputs.artifact-dir }}"
        summary_path="${{ inputs.artifact-dir }}/safe-agent-summary.md"
        safety_scorecard_path="${{ inputs.artifact-dir }}/safety-scorecard.md"
        policy_report_path="${{ inputs.artifact-dir }}/policy-report.json"
        log_path="${{ inputs.artifact-dir }}/safe-agent.log"

        # Seed fallback artifacts so failed runs still upload actionable context.
        cat > "${summary_path}" <<'EOF'
        ### Safe Agent CI Summary
        - Result: ❌ FAIL
        - Reason: safe-agent exited before writing summary output.
        EOF
        cat > "${safety_scorecard_path}" <<'EOF'
        ### Safe Agent Safety Scorecard
        - Result: ❌ FAIL
        - Reason: safe-agent exited before writing scorecard output.
        EOF
        cat > "${policy_report_path}" <<'EOF'
        {
          "status": "failed",
          "error": "safe-agent exited before writing policy report output.",
          "events": []
        }
        EOF

        cmd=(
          safe-agent
          "${{ inputs.task }}"
          --non-interactive
          --ci-summary-file
          "${summary_path}"
          --safety-scorecard-file
          "${safety_scorecard_path}"
          --policy-report
          "${policy_report_path}"
        )

        if [ -n "${{ inputs.fail-on-risk }}" ]; then
          cmd+=(--fail-on-risk "${{ inputs.fail-on-risk }}")
        fi

        if [ "${{ inputs.dry-run }}" = "true" ]; then
          cmd+=(--dry-run)
        fi
        if [ -n "${{ inputs.policy-file }}" ]; then
          cmd+=(--policy "${{ inputs.policy-file }}")
        fi
        if [ -n "${{ inputs.policy-preset }}" ]; then
          cmd+=(--policy-preset "${{ inputs.policy-preset }}")
        fi

        "${cmd[@]}" 2>&1 | tee "${log_path}"
        exit_code=${PIPESTATUS[0]}

        echo "summary_path=${summary_path}" >> "$GITHUB_OUTPUT"
        echo "safety_scorecard_path=${safety_scorecard_path}" >> "$GITHUB_OUTPUT"
        echo "policy_report_path=${policy_report_path}" >> "$GITHUB_OUTPUT"
        echo "log_path=${log_path}" >> "$GITHUB_OUTPUT"
        echo "exit_code=${exit_code}" >> "$GITHUB_OUTPUT"

        exit "${exit_code}"
