name: Safe Agent PR Risk Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      task:
        description: "Task for safe-agent to evaluate."
        required: false
        default: "scan repository for risky configuration and secret-handling changes; do not edit files"
      fail_on_risk:
        description: "Optional risk threshold (low|medium|high|critical)."
        required: false
        default: ""
      dry_run:
        description: "Run in dry-run mode."
        required: false
        default: true
        type: boolean
      policy_file:
        description: "Optional policy file path."
        required: false
        default: ""
      policy_preset:
        description: "Optional preset (startup|fintech|games)."
        required: false
        default: ""
      diff_ref:
        description: "Optional base ref for --diff-gate (used when API key is unavailable)."
        required: false
        default: ""

permissions:
  contents: read

concurrency:
  group: safe-agent-pr-gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  risk-gate:
    name: Safe Agent CI Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: gate
        name: Run Safe Agent review
        uses: ./.github/actions/safe-agent-review
        with:
          task: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.task || 'scan repository for risky configuration and secret-handling changes; do not edit files' }}
          fail-on-risk: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.fail_on_risk || '' }}
          dry-run: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run || 'true' }}
          policy-file: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.policy_file || '' }}
          policy-preset: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.policy_preset || '' }}
          diff-ref: ${{ github.event_name == 'pull_request' && format('origin/{0}', github.base_ref) || github.event_name == 'workflow_dispatch' && github.event.inputs.diff_ref || '' }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Attach summary to job output
        if: always()
        shell: bash
        run: |
          if [ -f "${{ steps.gate.outputs.summary_path }}" ]; then
            cat "${{ steps.gate.outputs.summary_path }}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### Safe Agent CI Summary" >> "$GITHUB_STEP_SUMMARY"
            echo "- Result: âŒ FAIL" >> "$GITHUB_STEP_SUMMARY"
            echo "- Summary file missing." >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ -f "${{ steps.gate.outputs.safety_scorecard_path }}" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            cat "${{ steps.gate.outputs.safety_scorecard_path }}" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload risk artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: safe-agent-risk-gate-${{ github.run_id }}
          path: |
            ${{ steps.gate.outputs.summary_path }}
            ${{ steps.gate.outputs.safety_scorecard_path }}
            ${{ steps.gate.outputs.policy_report_path }}
            ${{ steps.gate.outputs.run_result_path }}
            ${{ steps.gate.outputs.log_path }}
          if-no-files-found: warn
